<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>libcp2p: Minimal RPC</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">libcp2p
   </div>
   <div id="projectbrief">A libp2p-like protocol with first class support for embedded systems. End goal is a protocol that can run on anything from your fridge, embedded systems, and anything else. Higher level languages bindings will be done via FFI. Heavy WIP</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "../../search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('d2/d17/md__media_solidity__d_a_t_a__code__r_trade_ltd_libcp2p_docs__m_i_n_i_m_a_l__r_p_c.html','../../'); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Minimal RPC </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>There is a very minimal RPC framework included for sending messages between peers. It is not intended as a full on RPC system, and simply as a way to help two peers communicate. You can implement your own options ontop of this RPC framework by using the <code>ARBITRARY</code> message type, which allows for implementation defined behavior.</p>
<h1><a class="anchor" id="autotoc_md41"></a>
Messages</h1>
<h2><a class="anchor" id="autotoc_md42"></a>
Packet Diagram</h2>
<p>The actual RPC packets sent are illustrated below:</p>
<p><img src="https://gateway.temporal.cloud/ipfs/QmTH9t2FHSDzPo4yQBi4VRMfiVuYgySch4CRUyeDFhCv6g" alt="" class="inline"/></p>
<h2><a class="anchor" id="autotoc_md43"></a>
Types</h2>
<p>The following message types are denoted as an enum <code>MESSAGE_TYPES</code></p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Type </th><th class="markdownTableHeadNone">Purpose  </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">MESSAGE_WANT_PEER_ID </td><td class="markdownTableBodyNone">Informs a peer we want information for a particular peerid. This is typically used for two purposes. One when connecting to a peer and establishing an ECDH key agreement it allows us to request the public key the peer. The other is used for exchanging information about other peers  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">MESSAGE_HAVE_PEER_ID </td><td class="markdownTableBodyNone">Sent in response to <code>MESSAGE_WANT_PEER_ID</code> and indicates we have the information about a peer that was requested  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">MESSAGE_WANT_PUB_KEY </td><td class="markdownTableBodyNone">Informs a peer we want the public key corresponding to a PeerID  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">MESSAGE_HAVE_PUB_KEY </td><td class="markdownTableBodyNone">Sent in resposne to a <code>MESSAGE_WANT_PUB_KEY</code> and indicates we have the public key being request  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">MESSAGE_START_ECDH </td><td class="markdownTableBodyNone">Informs a peer we want to start an ECDH key agreement process  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">MESSAGE_BEGIN_ECDH </td><td class="markdownTableBodyNone">Sent ins response to a <code>MESSAGE_START_ECDH</code> and informs the peer to begin the process  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">MESSAGE_ARBITRARY </td><td class="markdownTableBodyNone">Arbitrary message type allowing for implementation defined behavior  </td></tr>
</table>
<h2><a class="anchor" id="autotoc_md44"></a>
Encoding</h2>
<p>Messages are encoded on the wire using CBOR encoding. When sending a message the first byte is used to indicate the size of the message data. Essentailly a single message looks like, where <code>X</code> is determined by the first byte sent:</p>
<div class="fragment"><div class="line">| 1 Byte            | X Bytes     |</div>
<div class="line">| size of remainder | actual data |</div>
</div><!-- fragment --><p>Note that the first byte <b>isn't</b> CBOR encoded data, while the remainder of the message is CBOR encoded. We do this for simplicity sakes, making it require slightly less work to process the message, as if we first the first byte encoded into CBOR, it would require slightly more work involved in processing.</p>
<h2><a class="anchor" id="autotoc_md45"></a>
Fields</h2>
<p>Every message contains three fields before being encoded into CBOR</p>
<p>1) <code>type</code> which is a MESSAGE_TYPES_T enum 2) <code>len</code> which is the size of <code>data</code> 3) <code>data</code> which is the actual message data</p>
<p>All fields must contain data. If you really do not have actual message data to send, simply set <code>data</code> to a null terminator (<code>\0</code>) and <code>len</code> to 1.</p>
<h2><a class="anchor" id="autotoc_md46"></a>
Sending And Receiving</h2>
<p>To simplify the process of sending and receiving messages <code><a class="el" href="../../d5/d48/messages_8h.html" title="defines message types and tooling for a very minimal RPC framework">network/messages.h</a></code> contains two convenience functions:</p>
<ul>
<li>1) <code>handle_receive</code><ul>
<li>abstracts the details of receiving a message</li>
<li>allocates memory internally for the returned struct</li>
</ul>
</li>
<li>2) <code>handle_send</code><ul>
<li>abstracts the details of sending a message</li>
</ul>
</li>
</ul>
<p>The usage of these two functions removes the need for all message preprocessing. Note however when sending messages, you'll need to provide the <code>message_t</code> struct, but <code>handle_send</code> will take care of CBOR encoding the data, and properly sending it on the wire.</p>
<h2><a class="anchor" id="autotoc_md47"></a>
Sending</h2>
<p>1) Allocate memory for a <code>message_t</code> instance 2) Populate fields 3) CBOR encode <code>message_t</code> with <code>cbor_encode_message_t</code> 4) Get send buffer length with <code>get_encoded_send_buffer_len</code> 5) Initialize <code>unsigned char</code> array to buffer length 6) Populate send buffer with <code>get_encoded_send_buffer</code> 7) Send data with <code>send</code> or <code>sendto</code></p>
<h2><a class="anchor" id="autotoc_md48"></a>
Limitations</h2>
<p>At the moment individual RPC messages can't be larger than 8192 bytes (8KiB), although this may be removed in the future. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="../../doxygen.png" alt="doxygen"/></a> 1.8.17 </li>
  </ul>
</div>
</body>
</html>
